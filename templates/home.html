<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intranet Corporativa</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="intranet-container">
        
        <div class="header-section">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="background: #e0e7ff; padding: 10px; border-radius: 50%; font-size: 1.5rem;">ğŸ¥</div>
                <div>
                    <h2 style="margin: 0;">Portal Interno</h2>
                    <small style="color: #666;">Sistema de GestiÃ³n</small>
                </div>
            </div>

            <div>
                {% if current_user.is_authenticated %}
                    <span style="margin-right: 15px;">Hola, <b>{{ current_user.username }}</b></span>
                    <a href="/dashboard" class="btn-action btn-blue">Mi Panel ğŸ“‚</a>
                {% else %}
                    <a href="/login" class="btn-action btn-blue">Iniciar SesiÃ³n ğŸ”</a>
                {% endif %}
            </div>
        </div>

        <div class="widget widget-time">
            <div class="clock-container">
                <div class="time-wrapper">
                    <span id="hours">--</span>:<span id="minutes">--</span>
                    <span id="seconds" class="seconds-small">00</span>
                </div>
                <div id="date" class="date-badge">Cargando fecha...</div>
            </div>
        </div>

        <div class="widget widget-weather">
            <div style="font-size: 2rem;">ğŸŒ¤ï¸</div>
            <div id="weather-temp" class="weather-temp">--Â°C</div>
            <div id="weather-desc" class="weather-desc">Actualizando...</div>
            <div class="weather-loc">Corrientes Capital</div>
        </div>

        <div class="widget widget-files">
            <h3>ğŸ” Documentos del Sistema</h3>
            
            <input type="text" id="searchInput" class="search-input" placeholder="Buscar archivo, protocolo, guÃ­a..." autocomplete="off">
            <div id="suggestions" style="display:none; background:white; border:1px solid #ccc; position:absolute; z-index:100; width: 45%; border-radius: 0 0 10px 10px;"></div>

            <ul class="file-list">
                {% for file in files %}
                    <li class="file-item">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2rem;">
                                {% if file.visibility == 'public' %} ğŸŒ
                                {% elif file.visibility == 'salud' %} ğŸ¥
                                {% elif file.visibility == 'admin' %} ğŸ“‹
                                {% else %} ğŸ”’
                                {% endif %}
                            </span>
                            <div>
                                <strong>{{ file.filename }}</strong><br>
                                <small style="color: grey;">De: {{ file.owner.username }}</small>
                            </div>
                        </div>
                        <a href="{{ url_for('download', file_id=file.id) }}" class="btn-action" style="background: #e5e7eb; color: #333;">â¬‡ï¸</a>
                    </li>
                {% else %}
                    <p style="text-align: center; color: #999; margin-top: 20px;">No hay archivos visibles.</p>
                {% endfor %}
            </ul>
        </div>

        <div class="widget widget-news">
            <h3>ğŸ“° Novedades</h3>
            <div style="margin-bottom: 15px;">
                <strong style="color: #4f46e5;">Nueva polÃ­tica de vacaciones</strong><br>
                <small style="color: #666;">Hace 2 horas</small>
                <p style="font-size: 0.9rem;">Se recuerda a todo el personal administrativo cargar sus licencias antes del 20...</p>
            </div>
            <hr style="border: 0; border-top: 1px solid #eee;">
            <div style="margin-bottom: 15px;">
                <strong style="color: #4f46e5;">Mantenimiento de Servidores</strong><br>
                <small style="color: #666;">Ayer</small>
                <p style="font-size: 0.9rem;">Cortes intermitentes programados para el fin de semana.</p>
            </div>
        </div>

        <div class="widget widget-photos">
            <h3>ğŸ“¸ GalerÃ­a</h3>
            <div class="photo-grid">
                <img src="https://picsum.photos/200/200?random=1" alt="Foto 1">
                <img src="https://picsum.photos/200/200?random=2" alt="Foto 2">
                <img src="https://picsum.photos/200/200?random=3" alt="Foto 3">
            </div>
        </div>

    </div>

    <script>
        // 1. RELOJ
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            document.getElementById('hours').textContent = hours;
            document.getElementById('minutes').textContent = minutes;
            document.getElementById('seconds').textContent = seconds;
            
            const dateString = now.toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('date').textContent = dateString.charAt(0).toUpperCase() + dateString.slice(1);
        }
        setInterval(updateClock, 1000);
        updateClock();

        // 2. CLIMA CORRIENTES (-27.46, -58.83)
        fetch('https://api.open-meteo.com/v1/forecast?latitude=-27.46&longitude=-58.83&current_weather=true')
            .then(res => res.json())
            .then(data => {
                const temp = Math.round(data.current_weather.temperature);
                document.getElementById('weather-temp').textContent = temp + "Â°C";
                document.getElementById('weather-desc').textContent = "Viento: " + data.current_weather.windspeed + " km/h";
            })
            .catch(() => {
                document.getElementById('weather-desc').textContent = "No disponible";
            });

        // 3. BUSCADOR
        const input = document.getElementById('searchInput');
        const suggestionsBox = document.getElementById('suggestions');

        input.addEventListener('keyup', function() {
            const query = input.value;
            if (query.length < 2) { suggestionsBox.style.display = 'none'; return; }

            fetch(`/api/search_suggestions?q=${query}`)
                .then(res => res.json())
                .then(data => {
                    suggestionsBox.innerHTML = '';
                    if (data.length > 0) {
                        suggestionsBox.style.display = 'block';
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.style.padding = '10px';
                            div.style.cursor = 'pointer';
                            div.style.borderBottom = '1px solid #eee';
                            div.innerHTML = `ğŸ“„ ${item.filename}`;
                            div.onclick = () => window.location.href = `/download/${item.id}`;
                            suggestionsBox.appendChild(div);
                        });
                    } else { suggestionsBox.style.display = 'none'; }
                });
        });
        
        document.addEventListener('click', (e) => {
            if (e.target !== input) suggestionsBox.style.display = 'none';
        });
    </script>
</body>
</html>